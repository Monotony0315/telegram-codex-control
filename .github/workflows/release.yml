name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Build release artifacts
        run: |
          ./scripts/release-build.sh
      - name: Generate SBOM
        run: |
          ./scripts/generate-sbom.sh dist/sbom.cdx.json
      - name: Require signing key
        run: |
          if [ -z "${{ secrets.RELEASE_PRIVATE_KEY_PEM }}" ]; then
            echo "RELEASE_PRIVATE_KEY_PEM secret is required for signed releases."
            exit 1
          fi
      - name: Import signing key
        run: |
          mkdir -p .release
          cat <<'EOF' > .release/private.pem
          ${{ secrets.RELEASE_PRIVATE_KEY_PEM }}
          EOF
          chmod 600 .release/private.pem
      - name: Sign artifacts
        env:
          RELEASE_PRIVATE_KEY_PATH: ${{ github.workspace }}/.release/private.pem
          REQUIRE_ARTIFACT_SIGNATURES: "1"
        run: |
          ./scripts/sign-artifacts.sh
      - name: Remove private key from workspace
        run: |
          rm -f .release/private.pem
      - name: Publish GitHub release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          if ! gh release view "${TAG}" >/dev/null 2>&1; then
            gh release create "${TAG}" --title "${TAG} - Telegram Codex Remote Control" --notes "Automated signed release."
          fi
          gh release upload "${TAG}" dist/* --clobber
